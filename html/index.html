<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <title>LightCommander</title>
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #000;
    }

    [data-theme="dark"] {
      --bg-color: #1e1e1e;
      --text-color: #ccc;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      flex:1;
      overflow-y: auto;
    }
    
    .wrapper {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .panel {
      flex: 1;
      border: 1px solid #ccc;
    }

    .panel-header {
      background-color: #f1f1f1;
      padding: 10px;
      display: flex;
      justify-content: space-between;
    }
    
    .panel-header input[type="text"] {
         width: calc(100% - 40px);
    }
    
    .panel-files {
        display: grid;
        grid-template-columns: 3fr 1fr 2fr;
        
    }
    
    .file-size {
        display: table-cell; /* display:flex;align-items:baseline;justify-content: flex-end;*/
        text-align: right;
        vertical-align: middle;
    }
    
    .file-timestamp {
        text-align:center;
    }
    
    .file {
      padding: 5px;
      cursor: pointer;
    }

    .file:hover {
      background-color: #ddd;
    }
    
    .selectedd {
        color:#E3CD07;
    }
    
    .selected-panel {
      background-color: #F5F3A4;
    }

    .directory {
      font-weight: bold;
    }

    footer {
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 10px;
      display: flex;
      justify-content: space-around;
      margin-top: auto;
    }

    footer button {
      background: none;
      border: 1px solid #fff;
      color: #fff;
      padding: 5px 10px;
      cursor: pointer;
    }

    footer button:hover {
      background-color: #555;
    }
    
    .overlay, div#help-panel {
        opacity:0.9;
        background-color:#ddd;
        position:fixed;
        width:100%;
        height:100%;
        top:0px;
        left:0px;
        display: grid;
        justify-content: center;
        z-index:1000;
    }
    
    .image-with-button {
        width: 100%;
    }
    
    div#help-panel {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 2em;
        align-items: flex-start;
        align-content: center;
        
    }
    
    .narrow {
        grid-auto-rows: min-content;
        justify-content: center;
    }
    
    .wide {
        grid-template-columns: 1fr;
    }
    
    .center-div {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 1001;
    }
    
    .float-button {
          background-color: #3d5d91;
          border: none;
          color: #e9ebf0;
          padding: 20px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          margin: 4px 2px;
          cursor: pointer;
          border-radius: 40%;
          z-index: 1001;
    }
    
    .btn-back {
          position: fixed; 
          bottom: 0;
          right: 0;
    }
    .btn-save {
          position: fixed; 
          bottom: 62px;
          right: 0;
    }
    
    .btn-right {
          position: fixed;
          right: 0;
          top: 50%;
          transform: translateY(-50%);
    }
    
    .btn-left {
          position: fixed;
          left: 0;
          top: 50%;
          transform: translateY(-50%);
    }
    
    .btn-mark {
          position: fixed;
          right: 0;
          top: 0;
    }
    
    /* Dropdown Button */
    .dropbtn {
      border: none;
    }
    
    /* The container <div> - needed to position the dropdown content */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    
    /* Dropdown Content (Hidden by Default) */
    .dropdown-content, .dropdown-content-right {
      display: none;
      position: absolute;
      background-color: #f1f1f1;
      min-width: 84px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
    }
    
    /* Links inside the dropdown */
    .dropdown-content a, .dropdown-content-right a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
    }
    
    .marked::before {
        content: "‚úì"; /* ‚Üì */
        color: #777;
        margin-right: 2px;
    }
    
    .marked-back::before {
        content: "‚Üë"; 
        color: #788;
        margin-right: 2px;
    }
    
    /* Change color of dropdown links on hover */
    .dropdown-content a:hover, .dropdown-content-right a:hover {background-color: #ddd;}
    
    /* Show the dropdown menu on hover */
    .dropdown:hover .dropdown-content, .dropdown:hover .dropdown-content-right {display: block;}
    
    /* Change the background color of the dropdown button when the dropdown content is shown */
    .dropdown:hover .dropbtn {background-color: #3e8e41;}
    
       /* Dropdown Content (Hidden by Default) */
    .dropdown-content-right {
      right: 0;
    }
    
    ul#left-bookmarks {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 120px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 1;
    }
    
    @media (prefers-color-scheme: dark) {
        :root {
            --bg-color: #1e1e1e;
            --text-color: #ccc;
            color-scheme: dark;
        }
        .selected-panel {
            background-color: #706706;
        }
        .panel-header, .file:hover {
             background-color: #738584;
        }
        .overlay, div#help-panel {
            opacity:0.9;
            background-color:#333;
        }
        .dropdown-content a, .dropdown-content-right a {
            color: gray;
        }
        .dropdown-content, .dropdown-content-right {
            background-color: #212121;
        }
        .dropdown-content a:hover, .dropdown-content-right a:hover {background-color: #444;}
        .image-with-button {
            background-color:#99ccff; color: #333;
        }
    } 
  </style>
  <script src="/cmd/js/common.js" language="Javascript"></script>
</head>
<body>
<div class="wrapper">
  <main>
    <div class="panel" id="left-panel">
      <div class="panel-header">
        <input type="text" id="left-dir" value="/" class="selected-panel" onfocus="selectPanel(this)" />
        <ul id="left-bookmarks">
            <li onclick="addBookmark('left')">Add the current</li>
        </ul>
        <div class="dropdown">
            <button class="dropbtn" onclick="requestPanel('left')">üîÑ</button>
            <div class="dropdown-content" id="myDiv">
                <a href="javascript:sorts['left']==1?sorts['left']=0:sorts['left']=1;var aEls = document.getElementById('myDiv').querySelectorAll('a');if (sorts['left']==1) aEls[0].classList.add('marked');else aEls[0].classList.remove('marked','marked-back');aEls[1].classList.remove('marked','marked-back');aEls[2].classList.remove('marked','marked-back')">Z..A</a>
                <a href="javascript:sorts['left']==2?sorts['left']=3:sorts['left']=2;document.getElementById('myDiv').querySelectorAll('a').forEach(el => el.classList.remove('marked','marked-back'));document.getElementById('myDiv').querySelector('a:nth-of-type(2)').classList.add(sorts['left']==2?'marked':'marked-back')">Time</a>
                <a href="javascript:sorts['left']==4?sorts['left']=5:sorts['left']=4;document.getElementById('myDiv').querySelectorAll('a').forEach(el => el.classList.remove('marked','marked-back'));document.getElementById('myDiv').querySelector('a:nth-of-type(3)').classList.add(sorts['left']==4?'marked':'marked-back')">Size</a>
            </div>
        </div>
      </div>
      <div id="left-files" class="panel-files"></div>
    </div>

    <div class="panel" id="right-panel">
      <div class="panel-header">
        <input type="text" list="right-bookmarks" id="right-dir" value="/" onfocus="selectPanel(this)" />
        <datalist id="right-bookmarks">
            <option value="Add the current">
        </datalist>
        <div class="dropdown">
            <button class="dropbtn" onclick="requestPanel('right')">üîÅ</button>
            <div class="dropdown-content-right" id="myDiv-right">
                <a href="javascript:sorts['right']==1?sorts['right']=0:sorts['right']=1;var aEls = document.getElementById('myDiv-right').querySelectorAll('a');if (sorts['right']==1) aEls[0].classList.add('marked');else aEls[0].classList.remove('marked','marked-back');aEls[1].classList.remove('marked','marked-back');aEls[2].classList.remove('marked','marked-back')">Z..A</a>
                <a href="javascript:sorts['right']==2?sorts['right']=3:sorts['right']=2;document.getElementById('myDiv-right').querySelectorAll('a').forEach(el => el.classList.remove('marked','marked-back'));document.getElementById('myDiv-right').querySelector('a:nth-of-type(2)').classList.add(sorts['right']==2?'marked':'marked-back')">Time</a>
                <a href="javascript:sorts['right']==4?sorts['right']=5:sorts['right']=4;document.getElementById('myDiv-right').querySelectorAll('a').forEach(el => el.classList.remove('marked','marked-back'));document.getElementById('myDiv-right').querySelector('a:nth-of-type(3)').classList.add(sorts['right']==4?'marked':'marked-back')">Size</a>
            </div>
        </div>
      </div>
      <div id="right-files" class="panel-files"></div>
    </div>
  </main>

  <footer>
      <button onclick="handleFunction('F1')">F1 Help</button>
    <button onclick="handleFunction('F2')">F2 Panel</button>
    <button onclick="handleFunction('F3')">F3 View</button>
    <button onclick="handleFunction('F4')">F4 Edit</button>
    <button onclick="handleFunction('F5')">F5 Copy</button>
    <button onclick="handleFunction('F6')">F6 Move</button>
    <button onclick="handleFunction('F7',event)">F7 Mkdir</button>
    <button onclick="handleFunction('F8')">F8 Delete</button>
    <button onclick="handleFunction('F9')">F9 Upload</button>
    <button onclick="handleFunction('F10')">F10 Zip</button>
  </footer>
  </div>
    <dialog >
      <p></p>
      <form method="dialog">
          <p id="extra_input" hidden><input type="text" id="some_txt" name="some_txt" required tabindex="2"/></p>
        <div>
          <button value="cancel" autofocus formmethod="dialog" formnovalidate tabindex="0">Cancel</button>
          <button id="confirmBtn" value="default" tabindex="1">Confirm</button>
        </div>
      </form>
    </dialog>
    
  <script>
    const WSKT_URL = './com'
    const UPL_URL = './upload';
    const PRG_NAME = ' LightCommander'
    const LOCALE = navigator.language
    var wskt = new WebSocket(WSKT_URL)
    initWSHandlers()
    //document.body.dataset.theme = 'dark';
    var accum = ''
    
    var DRIVE = ''
    var SEP = '/'
    
    var pending = []
    var modified = 0
    let sorts = {}
    
    window.addEventListener('keydown', function(event) {
      //console.log('Key Pressed:', event.key);
      //console.log('Key Code:', event.code);
       
      if (event.key == 'Delete' || event.code == 'NumLock'  || event.code == 'Insert') {
          const el = document.querySelector('.file:hover');
          if (el) {
              event.preventDefault();
              el.classList.toggle('selectedd');
          }
      } else if (event.key == 'F1' || event.key == 'F2' ||
      event.key == 'F3' || event.key == 'F4' ||
      event.key == 'F5' || event.key == 'F6' ||
      event.key == 'F7' || event.key == 'F8' ||
      event.key == 'F9' || event.key == 'F10') {
          event.preventDefault();
          if (event.ctrlKey) {
              if (event.key == 'F1') {
                  alignPanel('right')
              }
              if (event.key == 'F2') {
                  alignPanel('left')
              }
          } else if (event.shiftKey) {
              if (event.key == 'F7') {
                  openSearch()
              }
          } else {
             handleFunction(event.key)
          }
      } else if (event.key == 'F13') {
           event.preventDefault();
           handleFunction('F3')
      } else if (event.key == 'F14') {
          event.preventDefault();
          handleFunction('F4')
      } else if (event.key == 'F15') {
          event.preventDefault();
          handleFunction('F2')
      } else if (event.key == 'F16') {
          event.preventDefault();
          handleFunction('F5')
      } else if (event.key == 'Escape' || event.ctrlKey && event.code == 'KeyQ') {
          event.preventDefault();
          goBack()
      } else if (event.code == 'NumpadMultiply') {
          let lastChild = document.body.children[document.body.children.length - 1];
          if (lastChild.id == "view-edit") {
              return
          }
          event.preventDefault();
          const dirInputLeft = document.getElementById(`left-dir`);
          const panel = dirInputLeft.classList.contains('selected-panel')?'left':'right';
          const filesDiv = document.getElementById(`${panel}-files`);
          for (const child of filesDiv.children) {
              if (!child.classList.contains('file') && !child.classList.contains('directory'))  continue;
              if  (child.textContent == '..') { continue; }
              child.classList.toggle('selectedd');
          }
      } else if (event.code == 'NumpadDivide') { // NumpadSubtract NumpadAdd
           let lastChild = document.body.children[document.body.children.length - 1];
          if (lastChild.id == "view-edit") {
              return
          }
          event.preventDefault();
          const dirInputLeft = document.getElementById(`left-dir`);
          const panel = dirInputLeft.classList.contains('selected-panel')?'left':'right';
          const filesDiv = document.getElementById(`${panel}-files`);
          for (const child of filesDiv.children) {
              if (!child.classList.contains('file') && !child.classList.contains('directory'))  continue;
              if  (child.textContent == '..') { continue; }
              child.classList.remove('selectedd');
          }
      } else if (event.code == 'NumpadEqual') { // =
        let lastChild = document.body.children[document.body.children.length - 1];
          if (lastChild.id == "view-edit") {
              return
          }
        event.preventDefault();
          const leftPanel = document.getElementById(`left-files`);
          const rightPanel = document.getElementById(`right-files`);
          const thisChilds = leftPanel.children.length < rightPanel.children.length?leftPanel.children:rightPanel.children
          const otherChilds = leftPanel.children.length < rightPanel.children.length?rightPanel.children:leftPanel.children
          for (const child of otherChilds) {
              if (!child.classList.contains('file') && !child.classList.contains('directory'))  continue;
              if  (child.textContent == '..') { continue; }
              child.classList.add('selectedd');
          }
          for (const child of thisChilds) {
              if (!child.classList.contains('file') && !child.classList.contains('directory'))  continue;
              if  (child.textContent == '..') { continue; }
              child.classList.add('selectedd');
              for (const childOther of otherChilds) {
                  if (!childOther.classList.contains('file') && !childOther.classList.contains('directory'))  continue;
                  if  (childOther.textContent == '..') { continue; }
                  if (childOther.textContent == child.textContent) { // compare also class and size
                      childOther.classList.remove('selectedd');
                      child.classList.remove('selectedd');
                      break
                  }
              }
          }
      } else if (event.ctrlKey) {
          if (event.code == 'KeyS') {
              event.preventDefault();
              saveEdited()
          } else if (event.code == 'KeyH') {
              event.preventDefault();
              showHelp()
          } else if (event.code == 'KeyR') {
              event.preventDefault();
              requestPanel('left')
              requestPanel('right')
          }
      } 
    });
    
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            saveEdited()
        } else {
            // probably reload content
        }
    });
    
    document.getElementById('left-dir').addEventListener('keydown', function(event) {
        if (event.keyCode === 40) { // Down arrow key
            event.preventDefault();
            const panel = 'left'
            document.querySelector('#left-bookmarks').style.display = 'block';
          
            const dirInput = document.getElementById(`${panel}-dir`);
            const bookmarks = document.getElementById(`${panel}-bookmarks`);
            const text = dirInput.value;
            for (const bmEl of bookmarks.children) {
                // TODO skip first elem
                if (bmEl.firstChild.nodeValue == text) {
                    bookmarks.firstChild.firstChild.nodeValue = 'Remove the bookmark'
                    return
                }
            }
            bookmarks.firstChild.firstChild.nodeValue = 'Add the current'
        }
      });
    
    function requestPanel(panelId,newDir) {
        if (!newDir)
            newDir = document.getElementById(`${panelId}-dir`).value;
        wsktSend(JSON.stringify({op:'dir', dir:newDir, panel:panelId}));
    }
    
    function alignPanel(panelId) {
        const dirInput = document.getElementById(`${panelId}-dir`);
        const targetPanel = panelId == 'right' ? 'left':'right';
        document.getElementById(`${targetPanel}-dir`).value = document.getElementById(`${panelId}-dir`).value;
        wsktSend(JSON.stringify({op:'dir', dir:dirInput.value, panel:targetPanel}))
    }
    
    function loadPanel(response) {
        document.querySelector('dialog').close();
        const panelId = response.panel;
        const sortCol = sorts[panelId]
        const dirInput = document.getElementById(`${panelId}-dir`);
        const filesDiv = document.getElementById(`${panelId}-files`);
        const dir = response.path?response.path:dirInput.value;
        dirInput.value = dir
          filesDiv.innerHTML = ''; //sortCol=5;
          if (!sortCol || sortCol == 0 || sortCol == 1) {
              response.dir.sort((a, b) => {if (a.dir && b.dir || !a.dir && !b.dir) return sortCol == 1?b.name.localeCompare(a.name):a.name.localeCompare(b.name);
                  if (a.dir && !b.dir) return -1; if (!a.dir && b.dir) return 1;
              })
          } else if (sortCol == 2 || sortCol == 3) {
              response.dir.sort((a, b) => {if (a.dir && b.dir || !a.dir && !b.dir) {
                     if (a.timestamp == b.timestamp) 
                        return a.name.localeCompare(b.name);
                     else return sortCol == 2?a.timestamp - b.timestamp:b.timestamp - a.timestamp
                  }
                  if (a.dir && !b.dir) return -1; if (!a.dir && b.dir) return 1;
              })
          } else if (sortCol == 4 || sortCol == 5) {
              response.dir.sort((a, b) => {if (a.dir && b.dir || !a.dir && !b.dir) {
                     if (a.size == b.size) 
                        return a.name.localeCompare(b.name);
                     else return sortCol == 4?a.size - b.size:b.size - a.size
                  }
                  if (a.dir && !b.dir) return -1; if (!a.dir && b.dir) return 1;
              })
          }
          //alert('load of '+response.dir.length)
          for (const fileEntry of response.dir) { 
            const div = document.createElement('div');
            div.textContent = fileEntry.name;
            div.className = `file ${fileEntry.dir ? 'directory' : ''}`;
            div.onclick = () => {
              if (fileEntry.dir) {
                let newDir = dir != (DRIVE + SEP) ? `${dir}${SEP}${fileEntry.name}`:`${dir}${fileEntry.name}`;
                newDir = normalizePath(newDir,SEP,DRIVE)
                // TODO update title if it's an active panel
                if (dirInput.classList.contains('selected-panel'))
                     document.title = getLastPathComponent(dirInput.value) + PRG_NAME
                requestPanel(panelId, newDir);
              } else {
                    if (navigator.maxTouchPoints > 0 || 'ontouchstart' in window) {
                        const el = document.querySelector('.file:hover');
                        if (el) {
                            if (el.classList.contains('selectedd')) {
                                if (confirm(`Would you like download ${fileEntry.name}`)) {
                                    const link = document.createElement("a");
                                    link.href = `${UPL_URL}/simdown/${dir}${SEP}${fileEntry.name}`;
                                    link.download = fileEntry.name;
                                    link.click();
                                }
                            };
                            el.classList.toggle('selectedd');
                        }
                    } else {
                        event.target.classList.toggle('selectedd')
                        if(event.target.classList.contains('selectedd')) {
                            if (confirm(`Would you like download ${fileEntry.name}`)) {
                                const link = document.createElement("a");
                                link.href = `${UPL_URL}/simdown/${dir}${SEP}${fileEntry.name}`;
                                link.download = fileEntry.name;
                                link.click();
                            }
                        }
                    }
              }
            };
            filesDiv.appendChild(div);
            const div_size = document.createElement('div');
            if (!fileEntry.dir)
                div_size.textContent = fileEntry.size;
            div_size.className = 'file-size'
            filesDiv.appendChild(div_size);
            const div_date = document.createElement('div');
            if (fileEntry.timestamp) {
                const dateFromMilliseconds = new Date(fileEntry.timestamp);
                div_date.textContent = dateFromMilliseconds.toLocaleString(LOCALE);
            }
            div_date.className = 'file-timestamp'
            filesDiv.appendChild(div_date);
          }
    }
    
    function initWSHandlers () {
        wskt.onopen = () => {
            while (pending.lenght > 0) {
                wskt.send(pending.pop() + '\r\r\r\n')
                /*for (msg of pending) {
                    wskt.send(msg + '\r\r\r\n')
                }*/
            }
        }
        
        wskt.onmessage = (event) => {
            accum += event.data
            if (!accum.endsWith('\n'))
               return;
            for (const chunk of accum.split(/\r?\n|\r|\n/g)) {
                if (!chunk)
                    continue;
            
                //const response = JSON.parse(chunk);
                let response;
                try {//console.log(chunk);
                     response = JSON.parse(chunk);
                } catch (e) {
                    console.error(e); // error in the above string (in this case, yes)!
                    alert('Invalid server response: '+trimString(chunk,50))
                    continue
                }
                if (response.panel == 'none') {
                    continue // like a ping
                } else if (response.panel == 'center' || response.op == 'edit') {
                    let lastChild = document.body.children[document.body.children.length - 1];
                    if (lastChild.id == "view-edit" || lastChild.id == "preview-upload" || lastChild.id == "help-panel") {
                        accum = ''
                        alert(`last child with id ${lastChild.id}, ignored`)
                        return
                    }
                    const div = document.createElement('div');
                    div.id = "view-edit"
                    if (response.op == 'edit') {
                        div.style.padding='0 1em' 
                        div.innerHTML = '<textarea style="font-size: large; width: 98%; box-sizing: border-box;" autofocus>'
                            + response.content + '</textarea>' +
                            ((navigator.maxTouchPoints > 0 || 'ontouchstart' in window)? '<button class="float-button btn-save" onclick="saveEdited()">‚éô</button><button onclick="goBack()" class="float-button btn-back">‚å´</button>':'') +
                            '<input type="hidden" value="' + response.file + '" />';
                        modified = response.modified; // TODO should be a hidden field too  
                        document.title = getLastPathComponent(response.file) + PRG_NAME
                    } else {
                        div.style = "overflow:scroll"
                        div.innerHTML = '<p style="padding: 1em 2em;white-space: pre-wrap;">' + response.content + '</p>' +
                            ((navigator.maxTouchPoints > 0 || 'ontouchstart' in window)? '<button onclick="goBack()" class="float-button btn-back">‚å´</button>':'');
                    }
                    div.className = 'overlay wide'
                    document.body.appendChild(div)
                } else if (response.panel == 'control') {
                    DRIVE = response.root
                    SEP = response.separator
                    //requestPanel('left', response.left? response.left:DRIVE + SEP);
                    //requestPanel('right', response.right? response.right:DRIVE + SEP);
                    const newDirL = response.left? response.left:DRIVE + SEP
                    const newDirR = response.right? response.right:DRIVE + SEP
                    wsktSend(JSON.stringify({op:'dir', dir:newDirL, panel:'left'}) + '\n' +
                      JSON.stringify({op:'dir', dir:newDirR, panel:'right'}));
                } else if (response.panel == 'info') {
                    if (response.kind) {
                        if (response.kind == 'exif') {
                            const infoDiv = document.createElement('div')
                            infoDiv.id = 'help-panel'; // good for info also
                            infoDiv.style.overflow = "scroll"
                            infoDiv.style.flexWrap = 'nowrap'
                            const infoUl = document.createElement('ul')
                            for (const prop of response.details) {
                                const infoLi = document.createElement('li')
                                infoLi.textContent = `${prop.tag} ‚Äì ${prop.value}`
                                infoUl.appendChild(infoLi)
                            }
                            infoDiv.appendChild(infoUl)
                            infoDiv.addEventListener("click", (e) => {
                               e.stopPropagation();
                               let lastChild = document.body.children[document.body.children.length - 1];
                                document.body.removeChild(lastChild);
                            }, { once: true });
                            document.body.appendChild(infoDiv)
                        }
                    } else {
                        if (response.message) {
                            alert(response.message)
                            continue
                        }
                        modified = response.modified || 0;
                        let filePath = response.file.split(SEP)
                        const fileName = filePath.pop()
                        const dir = filePath.join(SEP)
                        if (document.getElementById(`left-dir`).value == dir)
                            updateFile('left', fileName, modified, response.size)
                        if (document.getElementById(`right-dir`).value == dir)
                            updateFile('right', fileName, modified, response.size)
                        const savedDiv = document.createElement('div')
                        savedDiv.className = 'center-div'
                        savedDiv.textContent = 'saved'
                        document.body.appendChild(savedDiv)
                        
                        setTimeout(function() {
                            savedDiv.remove();
                        }, 1200);
                    }
                } else {
                    loadPanel (response)
                }
            }
            accum = ''
        }
        
        wskt.onerror = (event) => { 
            
        }
    }
    
    function handleFunction(key,e) {
        const dlg = document.querySelector('dialog')
        const msg = dlg.querySelector('p')
        const dirInputLeft = document.getElementById(`left-dir`);
        const dirInputRight = document.getElementById(`right-dir`);
        const srcPanel = dirInputLeft.classList.contains('selected-panel')?'left':'right';
        const files = getSelected(srcPanel)
        switch (key) {
            case 'F10': 
                if (files.length == 0) {
                    break
                }
                msg.innerHTML = 'What\'s the zip name?'
                const nameInput = dlg.querySelector("p#extra_input")
                nameInput.style.display = 'block'
                dlg.querySelector("#some_txt").value = ''
                const zipBtn = dlg.querySelector("#confirmBtn");
                zipBtn.style.visibility = "visible"
                zipBtn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  var zipName = dlg.querySelector("#some_txt").value;
                  const zipDirInput = document.getElementById(`${srcPanel}-dir`);
                  if (!zipName.endsWith('.zip')) {
                      zipName += '.zip'
                  }
                  wsktSend(JSON.stringify({op:'zip', src:zipDirInput.value, panel:srcPanel, zip:zipName, files:files}))
                }, { once: true });
                dlg.showModal();
                break
            case 'F3': 
                const el = document.querySelector('.file:hover');
                if (el) {
                    // TODO look up to find appropriate panel dir
                    if (el.parentElement.nodeName == 'DIV') {
                        const actPanel = el.parentElement.id.split('-', 1)[0]
                        const fileName = el.textContent
                        const fileExt = fileName.slice((Math.max(0, fileName.lastIndexOf(".")) || Infinity) + 1).toUpperCase();
                        if (fileExt == 'JPEG' || fileExt == 'JPG' || fileExt == 'PNG' || fileExt == 'WEBP' || fileExt == 'GIF') {
                            const div = document.createElement('DIV');
                            div.style.overflow = "scroll"
                            div.id = "view-edit"
                            div.tabindex = 0
                            const pic = document.createElement('img')
                            const dir = document.getElementById(`${actPanel}-dir`).value
                            pic.src = `${UPL_URL}/simdown/${dir}${SEP}${fileName}?show=image`
                            pic.style.marginLeft='auto'
                            pic.style.marginRight='auto'
                            div.appendChild(pic)
                            div.className = 'overlay wide'
                            div.style.opacity = '1.0'
                            document.body.appendChild(div)
                            div.addEventListener('click', (event) => {
                                event.stopPropagation();
                                wsktSend(JSON.stringify({op:'info', src:document.getElementById(`${actPanel}-dir`).value, panel:actPanel, file:fileName}))
                            })
                            div.focus()
                        } else
                            wsktSend(JSON.stringify({op:'show', src:document.getElementById(`${actPanel}-dir`).value, panel:actPanel, file:fileName}))
                        document.title = fileName
                    }
                } else {
                    var showFile = ''
                    var actPanel = srcPanel
                    if (files && files.length == 1) {
                        showFile = files[0];
                    } else {
                        actPanel = srcPanel == 'left'?'right':'left'
                        const altFiles = getSelected(actPanel)
                        if (altFiles && altFiles.length == 1) {
                            showFile = altFiles[0];
                        }
                    }
                    if (showFile) {
                        const fileExt = showFile.slice((Math.max(0, showFile.lastIndexOf(".")) || Infinity) + 1).toUpperCase();
                        if (fileExt == 'JPEG' || fileExt == 'JPG' || fileExt == 'PNG' || fileExt == 'WEBP' || fileExt == 'GIF') {
                            const div = document.createElement('div');
                            div.style = "overflow:scroll"
                            div.style.opacity = '1.0'
                            div.id = "view-edit"
                            const pic = document.createElement('img')
                            const dir = document.getElementById(`${actPanel}-dir`).value
                            pic.src = `${UPL_URL}/simdown/${dir}${SEP}${showFile}?show=image`
                            pic.style.marginLeft='auto'
                            pic.style.marginRight='auto'
                            pic.style.objectFit = 'none'
                            div.appendChild(pic)
                            div.className = 'overlay wide'
                            // create div for buttons and add over
                            if (navigator.maxTouchPoints > 0 || 'ontouchstart' in window) {
                                div.className = 'overlay image-with-button'
                                const btn = document.createElement('button')
                                btn.className ='float-button btn-back'
                                btn.textContent = '‚å´'
                                btn.addEventListener("click", (e) => {e.stopPropagation(); goBack()}, { once: true }); 
                                div.appendChild(btn)
                            }
                            const btnRight = document.createElement('button')
                            btnRight.className ='float-button btn-right'
                            btnRight.textContent = '‚ñ∑' // ‚óÅ  üóë ‚úì
                            btnRight.addEventListener("click", (e) => {
                                e.stopPropagation();
                                const filesDiv = document.getElementById(`${actPanel}-files`);
                                var after = false
                                for (const child of filesDiv.children) {
                                    if (!child.classList.contains('file') || child.classList.contains('directory'))  continue;
                                    if  (after) {
                                        showFile = child.textContent
                                        const showExt = showFile.slice((Math.max(0, showFile.lastIndexOf(".")) || Infinity) + 1).toUpperCase();
                                        if (showExt == 'JPEG' || showExt == 'JPG' || showExt == 'PNG' || showExt == 'WEBP' || showExt == 'GIF') {
                                            pic.src = `${UPL_URL}/simdown/${dir}${SEP}${showFile}?show=image`
                                            document.title = showFile
                                            break
                                        }
                                    }
                                    if (child.textContent == showFile) {
                                        after = true
                                    }
                                }
                            }); 
                            div.appendChild(btnRight)
                            // left
                            const btnLeft = document.createElement('button')
                            btnLeft.className ='float-button btn-left'
                            btnLeft.textContent = '‚óÅ'
                            btnLeft.addEventListener("click", (e) => {
                                e.stopPropagation();
                                const filesDiv = document.getElementById(`${actPanel}-files`);
                                var beforeFile = ''
                                for (const child of filesDiv.children) {
                                    if (!child.classList.contains('file') || child.classList.contains('directory'))  continue;
                                    if (child.textContent == showFile) {
                                        if (beforeFile) {
                                            showFile = beforeFile
                                            pic.src = `${UPL_URL}/simdown/${dir}${SEP}${showFile}?show=image`
                                            document.title = showFile
                                            break
                                        }
                                    }
                                    const currentFile = child.textContent
                                    const beforeExt = currentFile.slice((Math.max(0, currentFile.lastIndexOf(".")) || Infinity) + 1).toUpperCase();
                                    if (beforeExt == 'JPEG' || beforeExt == 'JPG' || beforeExt == 'PNG' || beforeExt == 'WEBP' || beforeExt == 'GIF') {
                                        beforeFile = child.textContent
                                    }
                                }
                            }); 
                            div.appendChild(btnLeft)
                            // mark
                            const btnMark = document.createElement('button')
                            btnMark.className ='float-button btn-mark'
                            btnMark.textContent = '‚úì'
                            btnMark.addEventListener("click", (e) => {
                                e.stopPropagation();
                                const filesDiv = document.getElementById(`${actPanel}-files`);
                                for (const child of filesDiv.children) {
                                    if (!child.classList.contains('file') || child.classList.contains('directory'))  continue;
                                    if (child.textContent == showFile) {
                                        child.classList.add('selectedd')
                                        break
                                    }
                                }
                            });
                            div.appendChild(btnMark)
                            div.addEventListener('click', (event) => {
                                event.stopPropagation();
                                wsktSend(JSON.stringify({op:'info', src:document.getElementById(`${actPanel}-dir`).value, panel:actPanel, file:showFile}))
                            })
                            document.body.appendChild(div)
                            document.title = showFile
                        } else
                            wsktSend(JSON.stringify({op:'show', src:document.getElementById(`${actPanel}-dir`).value, panel:actPanel, file:showFile}))
                    } else {
                        alert('Please select an item to show first')
                    }
                }
                break
            case 'F5': 
            case 'F6':
                const dstPanel = srcPanel == 'right'?'left':'right';
                const move = key == 'F6'
                if (files && files.length > 0) {
                    if (files.length == 1)
                        msg.innerHTML = (move?'Moving ':'Copying ') + files[0] + '...'
                    else
                        msg.innerHTML = `${move ? 'Moving' : 'Copying'} ${files.length} files...`
                    const srcDirInput = document.getElementById(`${srcPanel}-dir`);
                    const dstDirInput = document.getElementById(`${dstPanel}-dir`);
                    const extraInput = dlg.querySelector("p#extra_input")
                    const createBtn = dlg.querySelector("#confirmBtn");
                    if (dstDirInput.value == srcDirInput.value) {
                        // the op is possible only with changing name when 
                        if (files.length == 1) {
                            extraInput.style.display = 'block'
                             dlg.querySelector("#some_txt").value = files[0]
                            createBtn.style.visibility = "visible"
                            createBtn.addEventListener("click", (e) => {
                              const newName = dlg.querySelector("#some_txt").value;
                              wsktSend(JSON.stringify({op:(move?'move':'copy'), dst:dstDirInput.value,file:newName,src:srcDirInput.value, panel:dstPanel, files:files}))
                            }, { once: true });
                            dlg.showModal()
                        } 
                        break;
                    }
                    extraInput.style.display = "none"
                    const extraTxt = dlg.querySelector("#some_txt")
                    extraTxt.required = false
                    createBtn.style.visibility = "hidden"
                    dlg.show()
                    wsktSend(JSON.stringify({op:(move?'move':'copy'), dst:dstDirInput.value,src:srcDirInput.value, panel:dstPanel, files:files}))
                }
                break
            case 'F8':
                if (files && files.length > 0) {
                    if (files.length == 1)
                        msg.innerHTML = 'Delete ' + files[0] + '?'
                    else
                        msg.innerHTML = `Delete ${files.length} files?`
                    const extraInput = dlg.querySelector("p#extra_input")
                    extraInput.style.display = "none"
                    const extraTxt = dlg.querySelector("#some_txt")
                    extraTxt.required = false
                    const createBtn = dlg.querySelector("#confirmBtn");
                    createBtn.style.visibility = "visible"
                    createBtn.addEventListener("click", (e) => {
                      e.preventDefault();
                      const srcDirInput = document.getElementById(`${srcPanel}-dir`);
                      const same = document.getElementById(`left-dir`).value == document.getElementById(`right-dir`).value
                      wsktSend(JSON.stringify({op:'del', src:srcDirInput.value, panel:srcPanel, same:same, files:files}))
                    }, { once: true });
                    dlg.showModal()
                }
                break
            case 'F7':
                if (e && e.shiftKey) {
                    openSearch()
                    return
                }
                msg.innerHTML = 'What\'s the directory name?'
                const extraInput = dlg.querySelector("p#extra_input")
                extraInput.style.display = 'block'
                dlg.querySelector("#some_txt").value = ''
                const createBtn = dlg.querySelector("#confirmBtn");
                createBtn.style.visibility = "visible"
                createBtn.addEventListener("click", (e) => {

                  const dirName = dlg.querySelector("#some_txt").value;
                  const srcDirInput = document.getElementById(`${srcPanel}-dir`);
                  const same = document.getElementById(`left-dir`).value == document.getElementById(`right-dir`).value
                  wsktSend(JSON.stringify({op:'mkdir', src:srcDirInput.value, panel:srcPanel, same:same, file:dirName}))
                }, { once: true });
                dlg.showModal();
                break
            case 'F1':
                showHelp()
                break
            case 'F2':
                if (!dirInputLeft.classList.contains('selected-panel')) {
                    dirInputRight.classList.remove('selected-panel')
                    dirInputLeft.classList.add('selected-panel')
                    document.title = getLastPathComponent(dirInputLeft.value) + PRG_NAME
                } else {
                    dirInputLeft.classList.remove('selected-panel')
                    dirInputRight.classList.add('selected-panel')
                    document.title = getLastPathComponent(dirInputRight.value) + PRG_NAME
                }
                break
            case 'F4': 
                const elEd = document.querySelector('.file:hover');
                if (elEd) {
                    if (elEd.parentElement.nodeName == 'DIV') {
                        const actPanel = elEd.parentElement.id.split('-', 1)[0]
                        wsktSend(JSON.stringify({op:'edit', src:document.getElementById(`${actPanel}-dir`).value, panel:actPanel, file:elEd.textContent}))
                    }
                } else if (files && files.length == 1) {
                    wsktSend(JSON.stringify({op:'edit', src:document.getElementById(`${srcPanel}-dir`).value, panel:srcPanel, file:files[0]}))
                } else { // create one
                    msg.innerHTML = 'What\'s the file name?'
                    const extraInput = dlg.querySelector("p#extra_input")
                    extraInput.style.display = 'block'
                    dlg.querySelector("#some_txt").value = ''
                    const createBtn = dlg.querySelector("#confirmBtn");
                    createBtn.style.visibility = "visible"
                    createBtn.addEventListener("click", (e) => {
                      e.preventDefault();
                      dlg.close();
                      const fileName = dlg.querySelector("#some_txt").value;
                      wsktSend(JSON.stringify({op:'edit', src:document.getElementById(`${srcPanel}-dir`).value, panel:srcPanel, file:fileName }))
                    }, { once: true });
                    dlg.showModal();
                }
                break
            case 'F9':
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.multiple = true; // Allows selection of multiple files
                fileInput.addEventListener('change', (event) => {
                    const selectedFiles = event.target.files;
                    if (selectedFiles.length > 0) {
                        const fileList = document.createElement('div');
                        fileList.style = "overflow:scroll"
                        fileList.id = "preview-upload"
                        //div.textContent = response.content;
                        
                        fileList.className = 'overlay narrow'
                        
                        document.body.appendChild(fileList)
                        const list = document.createElement("ul");
                        fileList.appendChild(list);
                        for (const file of selectedFiles) {
                          const li = document.createElement("li");
                          list.appendChild(li);
                    
                          const img = document.createElement("img");
                          img.src = URL.createObjectURL(file);
                          img.height = 60;
                          li.appendChild(img);
                          const info = document.createElement("span");
                          info.textContent = `${file.name}: ${file.size} bytes`;
                          li.appendChild(info);
                        }
                        const proceedButton = document.createElement('button');
                        proceedButton.textContent = 'Proceed';
                        proceedButton.id = 'proceedButton';
                        //proceedButton.className = 'dynamic-btn';
                        fileList.appendChild(proceedButton);
                            
                        proceedButton.addEventListener('click', () => {
                            const progressBar = document.createElement("progress");
                            progressBar.setAttribute("max", "100");
                            fileList.appendChild(progressBar);
                            sendFile(selectedFiles,srcPanel,progressBar)
                            // TODO close the panel
                        }, { once: true });

                    } else {
                        console.log('No files selected.');
                    }
                });
                fileInput.click();

                break
            default: 
                // Implement file operation based on key
                alert(`${key} pressed!`);
        }
    }
    
    function  selectPanel(editLine) {
        if (editLine.classList.contains('selected-panel'))
            return
        const otherPanel = document.getElementById(`left-dir`) == editLine? document.getElementById(`right-dir`):document.getElementById(`left-dir`)
        editLine.classList.add('selected-panel')
        otherPanel.classList.remove('selected-panel')
    }

    function getSelected(panelId) {
        const filesDiv = document.getElementById(`${panelId}-files`);
        var res = []
        filesDiv.querySelectorAll('div.selectedd').forEach((divEl) => { res.push(divEl.textContent) })
        return res
    }
    
    function openSearch() {
        const dirInputLeft = document.getElementById(`left-dir`);
        const srcPanel = dirInputLeft.classList.contains('selected-panel')?'left':'right';
        const dlg = document.querySelector('dialog')
        const msg = dlg.querySelector('p')
        msg.innerHTML = 'What\'s to find?'
        const extraInput = dlg.querySelector("p#extra_input")
        extraInput.style.display = 'block'
        dlg.querySelector("#some_txt").value = ''
        dlg.querySelector("#some_txt").focus()
        const createBtn = dlg.querySelector("#confirmBtn");
        createBtn.style.visibility = "visible"
        createBtn.addEventListener("click", (e) => {

          const searchStr = dlg.querySelector("#some_txt").value;
          const srcDirInput = document.getElementById(`${srcPanel}-dir`);
          const same = dirInputLeft.value == document.getElementById(`right-dir`).value
          wsktSend(JSON.stringify({op:'search', dir:srcDirInput.value, panel:srcPanel, same:same, file:searchStr}))
        }, { once: true });
        dlg.showModal();
    }
    
    function addBookmark(panel) {
        const dirInput = document.getElementById(`${panel}-dir`);
        const bookmarks = document.getElementById(`${panel}-bookmarks`);
        const text = dirInput.value;
        for (const bmEl of bookmarks.children) {
            // TODO skip first elem
            if (bmEl.textContent == text) {
                bmEl.remove()
                bookmarks.style.display = 'none'
                return
            }
        }
        const node = document.createElement("Li");
         
        const textnode=document.createTextNode(text);
        node.appendChild(textnode);
        node.addEventListener('click', (event) => {
            event.stopPropagation();
            dirInput.value = textnode.nodeValue
            bookmarks.style.display = 'none'
            requestPanel(panel)
        })
        bookmarks.appendChild(node);
        bookmarks.style.display = 'none'
    }
    
    function updateFile(panelId, fileName, modified, size) {
        const filesDiv = document.getElementById(`${panelId}-files`);
        var update = false
        for (const child of filesDiv.children) {
            if (update) {
                if (child.classList.contains('file-size')) {
                    child.textContent = ''+size
                    continue
                }
                if (child.classList.contains('file-timestamp')) {
                    const dateFromMilliseconds = new Date(modified*1000);
                    child.textContent = dateFromMilliseconds.toLocaleString(LOCALE);
                    break
                }
            }
            if (!child.classList.contains('file') || child.classList.contains('directory'))  continue;
            if (child.textContent == fileName) {
                update = true
            }
        }
    }
    
    function saveEdited() {
          const editArea = document.querySelector('textarea');
          if (editArea) {
              event.preventDefault();
              const filePath = document.querySelector('input[type="hidden"]').value;
              const dirInputLeft = document.getElementById(`left-dir`);
              const srcPanel = dirInputLeft.classList.contains('selected-panel')?'left':'right';
              const same = document.getElementById(`left-dir`).value == document.getElementById(`right-dir`).value
              wsktSend(JSON.stringify({op:'save', same:same, panel:srcPanel, file:filePath, content:editArea.value, modified:modified?modified:0}))
          }
    }

    function sendFile(file, panel, progressBar) {
        const uri = `${UPL_URL}/simupld`; // the URL will depend on an installation topology
        const xhr = new XMLHttpRequest();
        const fd = new FormData();
        const dir = document.getElementById(`${panel}-dir`).value

        xhr.open("POST", uri, true);
        if (progressBar) {
            xhr.upload.addEventListener("progress", function(event) {
                if (event.lengthComputable) {
                  var percentComplete = (event.loaded / event.total) * 100;
                  progressBar.value = percentComplete;
                  progressBar.textContent = Math.round(percentComplete) + "%"; // Display percentage
                }
              })
        }
        xhr.onreadystatechange = () => {
          if (xhr.readyState === 4 && xhr.status === 200) {
              if ('Ok' == xhr.responseText) {
                  let lastChild = document.body.children[document.body.children.length - 1];
                  if (lastChild.id == "preview-upload") {
                      document.body.removeChild(lastChild);
                  }
                  requestPanel(panel)
              } else {
                  alert(xhr.responseText); // handle response.
              }
          }
        };
        fd.append("dir", dir);
        if (file[Symbol.iterator] !== undefined) {
            for (const el of file) {
                fd.append("upFile", el);
            }
        } else
            fd.append("upFile", file);
        // Initiate a multipart/form-data upload
        xhr.send(fd);
    }

    function wsktSend(load) {
        if (!wskt || wskt.readyState !== WebSocket.OPEN && wskt.readyState !== WebSocket.CONNECTING) { 
            pending.push(load)
            wskt = new WebSocket(WSKT_URL + '?restart')
            initWSHandlers()
        } else {
            wskt.send(load + '\r\r\r\n') // keep in sync with initWSHandlers
        }
    }
    
    function goBack() {
          let lastChild = document.body.children[document.body.children.length - 1];
          if (lastChild.id == "view-edit") {
            document.body.removeChild(lastChild);
            event.preventDefault();
          }
          if (lastChild.id == "preview-upload") {
              document.body.removeChild(lastChild);
              event.preventDefault();
          }
          if (lastChild.id == "help-panel") {
              document.body.removeChild(lastChild);
              event.preventDefault();
          }
          document.title = PRG_NAME
    }
    
    function showHelp() {
        const helpDiv = document.createElement('DIV');
        helpDiv.id = "help-panel"
        helpDiv.innerHTML = '<p>F1 - this screen</p>'+
        '<p>F2 - switch active panel</p>' +
        '<p>F3 - view hover or selected file</p>' +
        '<p>F4 - edit hover or selected file</p>' +
        '<p>F5 - copy selected file(s)</p>' +
        '<p>F6 - move selected file(s)</p>' +
        '<p>F7 - make a directory</p>' +
        '<p>F8 - delete selected file(s)</p>' +
        '<p>F9 - upload selected file(s)</p>' +
        '<p>F10 - zip selected file(s)</p>' +
        '<p>Shift+F7 - search</p>' +
        '<p>Esc - exit view, help or edit screen</p>' +
        '<p>Numpad * - invert selection</p>' +
        '<p>Numpad / - clear selection</p>' +
        '<p>Numpad = - compare panels, no size or type counted</p>' +
        '<p>^I - getting info on the panel</p>' +
        '<p>^R - refresh panels</p>' +
        '<p>^S - save edited content</p>'
        if (navigator.maxTouchPoints > 0 || 'ontouchstart' in window) {
            const btn = document.createElement('button')
            btn.className ='float-button btn-back'
            btn.textContent = '‚å´'
            btn.addEventListener("click", (e) => {e.stopPropagation(); goBack()}, { once: true }); 
            helpDiv.appendChild(btn)
        }
        document.body.appendChild(helpDiv)
    }
    
    function unloadWS() {
        wskt.close();
    }
  </script>
</body>
</html>